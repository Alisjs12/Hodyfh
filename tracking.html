<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مختبر حذيفة الذيب | تتبع</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@900&display=swap" rel="stylesheet">

    <style>
        :root { --neon-cyan: #00f2ff; --deep-dark: #020205; }
        body { background-color: var(--deep-dark); color: #fff; font-family: 'Cairo', sans-serif; }
        
        /* ستايل المربع الأزرق مثل الذي في صورتك */
        .tracking-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--neon-cyan);
            border-radius: 20px; padding: 30px; margin-top: 30px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        .id-input {
            background: transparent; border: 2px solid var(--neon-cyan); color: var(--neon-cyan);
            font-family: 'Orbitron'; font-size: 2.5rem; text-align: center; border-radius: 10px; width: 100%;
        }

        .diagnosis-result { display: none; margin-top: 25px; text-align: right; }
        
        /* تنسيق أزرار نعم ولا الجديدة */
        .approval-box {
            margin-top: 20px; padding: 15px; border-radius: 10px;
            background: rgba(255, 255, 255, 0.05); border: 1px dashed var(--neon-cyan);
        }
        .btn-yes { background: #28a745; color: white; border: none; padding: 8px 25px; border-radius: 5px; font-weight: bold; margin-left: 10px; }
        .btn-no { background: #dc3545; color: white; border: none; padding: 8px 25px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center text-center">
        <div class="col-lg-8">
            
            <div class="tracking-card">
                <input type="number" id="orderId" class="id-input mb-3" placeholder="000000">
                <button onclick="searchDevice()" class="btn btn-info w-100 py-3 fw-bold fs-5 mb-4">استعلام عن التقرير الفني</button>

                <div id="resultBox" class="diagnosis-result">
                    <h4 id="resModel" class="text-info fw-bold">موديل الجهاز: ---</h4>
                    <p id="resStatus" class="mb-3">حالة العمل: ---</p>
                    
                    <div class="p-3 bg-dark rounded border border-secondary mb-3">
                        <strong class="text-warning">سبب المشكلة (التشخيص):</strong>
                        <p id="resProblem" class="mt-2 mb-0">---</p>
                    </div>

                    <div id="approvalSection" class="approval-box">
                        <p class="mb-3">هل ترغب في البدء بعملية الإصلاح؟</p>
                        <div id="actionButtons">
                            <button onclick="setDecision('نعم، موافق على الإصلاح')" class="btn-yes">نعم، ابدأ</button>
                            <button onclick="setDecision('لا، غير موافق')" class="btn-no">لا، أريد استلامه</button>
                        </div>
                        <h5 id="successMsg" class="text-success mt-2" style="display:none;">تم إرسال ردك للمهندس حذيفة ✅</h5>
                    </div>
                </div>
            </div>

            <div class="mt-5 opacity-50">
                <input type="password" id="pass" class="form-control bg-dark text-white text-center mb-2" placeholder="رمز الدخول">
                <button onclick="accessAdmin()" class="btn btn-sm btn-outline-secondary w-100">لوحة التحكم</button>
                
                <div id="panel" style="display:none;" class="mt-3 p-3 border rounded">
                    <input type="number" id="newId" class="form-control mb-2" placeholder="رقم الجهاز">
                    <input type="text" id="newModel" class="form-control mb-2" placeholder="الموديل">
                    <textarea id="newProblem" class="form-control mb-2" placeholder="التشخيص الفني"></textarea>
                    <button onclick="saveData()" class="btn btn-primary w-100">نشر التقرير سحابياً</button>
                    <div id="customerRef" class="mt-2 text-info small"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://huzaifa-lab-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function searchDevice() {
        const id = document.getElementById('orderId').value;
        db.ref('orders/' + id).once('value').then((s) => {
            if(s.exists()){
                const d = s.val();
                document.getElementById('resultBox').style.display = 'block';
                document.getElementById('resModel').innerText = "موديل الجهاز: " + d.model;
                document.getElementById('resStatus').innerText = "حالة العمل: " + (d.status || "قيد التشخيص");
                document.getElementById('resProblem').innerText = d.problem;
                
                // لو الزبون رد سابقاً، نخفي الأزرار ونظهر الرد
                if(d.decision) {
                    document.getElementById('actionButtons').style.display = 'none';
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('successMsg').innerText = "ردك المسجل: " + d.decision;
                } else {
                    document.getElementById('actionButtons').style.display = 'block';
                    document.getElementById('successMsg').style.display = 'none';
                }
                // للمهندس: رؤية الرد في لوحة التحكم
                document.getElementById('customerRef').innerText = "قرار الزبون الحالي: " + (d.decision || "لم يقرر بعد");
            } else { alert("الرقم غير موجود"); }
        });
    }

    async function setDecision(val) {
        const id = document.getElementById('orderId').value;
        await db.ref('orders/' + id).update({ decision: val });
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('successMsg').style.display = 'block';
        document.getElementById('successMsg').innerText = "تم إرسال ردك بنجاح ✅";
    }

    async function saveData() {
        const id = document.getElementById('newId').value;
        const mo = document.getElementById('newModel').value;
        const pr = document.getElementById('newProblem').value;
        await db.ref('orders/' + id).set({ id, model: mo, problem: pr, status: "بانتظار موافقتك", decision: "" });
        alert("تم الحفظ بنجاح!");
        location.reload();
    }

    function accessAdmin() {
        if(document.getElementById('pass').value === "2025") document.getElementById('panel').style.display = 'block';
    }
</script>
</body>
</html>